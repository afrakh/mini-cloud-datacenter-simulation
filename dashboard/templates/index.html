<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Cloud DC â€” Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Mini Cloud DC</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="/topology">Topology</a></li>
        <li class="nav-item"><a class="nav-link" href="/logs">Logs</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="row">
    <!-- LEFT SIDE (Charts) -->
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Load</h5>
        <canvas id="requestsChart" height="150"></canvas>
      </div>
      <div class="card p-3 mb-3">
        <h5>Bandwidth (per-link)</h5>
        <canvas id="bandwidthChart" height="150"></canvas>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="col-md-6">
      <!-- ACTIVE HOSTS & SERVERS -->
      <div class="card p-3 mb-3">
        <h5>Active Hosts & Servers</h5>

        <h6>Servers</h6>
        <div id="servers" class="d-flex flex-wrap gap-2">Loading...</div>

        <h6 class="mt-3">Clients</h6>
        <div id="clients" class="d-flex flex-wrap gap-2">Loading...</div>
      </div>

      <!-- RECENT EVENTS -->
      <div class="card p-3 mb-3">
        <h5>Recent Events</h5>
        <ul id="eventsList" class="list-group"></ul>
      </div>
    </div>
  </div>
</div>

<!-- JS Libraries -->
<!-- Correct order -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/charts.js"></script>
<script src="/static/js/dashboard.js"></script>

<!-- Hosts/Servers loader -->
<script>
async function loadHosts() {
    try {
        const [serversRes, hostsRes] = await Promise.all([
            fetch('/api/active-servers'),
            fetch('/api/active-hosts')
        ]);

        const servers = await serversRes.json();
        const hosts = await hostsRes.json();

        const serversDiv = document.getElementById('servers');
        const clientsDiv = document.getElementById('clients');

        serversDiv.innerHTML = '';
        clientsDiv.innerHTML = '';

        // Render all servers
        servers.forEach(s => {
            const card = document.createElement('div');
            card.className = 'card p-2 m-1';
            card.style.width = '150px';
            // Color based on status
            card.style.backgroundColor = s.status === 'UP' ? '#d4edda' : '#f8d7da';
            card.innerHTML = `<strong>${s.id}</strong><br>${s.ip}<br>Status: ${s.status}`;
            serversDiv.appendChild(card);
        });

        // Render all hosts
        hosts.forEach(h => {
            const card = document.createElement('div');
            card.className = 'card p-2 m-1';
            card.style.width = '150px';
            card.style.backgroundColor = h.status === 'UP' ? '#d1ecf1' : '#f8d7da';
            let typeLabel = h.type ? ` (${h.type})` : '';
            card.innerHTML = `<strong>${h.id}</strong>${typeLabel}<br>${h.ip}<br>Status: ${h.status}`;
            clientsDiv.appendChild(card);
        });

    } catch (err) {
        console.error("Error loading servers/hosts:", err);
        document.getElementById('servers').innerText = "Error loading servers";
        document.getElementById('clients').innerText = "Error loading clients";
    }
}

// Refresh every 5s
window.addEventListener('load', () => {
    loadHosts();
    setInterval(loadHosts, 5000);
});

</script>

</body>
</html>
